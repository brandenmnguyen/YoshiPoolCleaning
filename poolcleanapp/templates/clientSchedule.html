{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="{% static 'clientSchedule.css' %}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

</head>

<body>

    <h1>Schedule an appointment</h1>


    <div id="appointmentContainer"></div>

    <script>

        const appointments = [
            {% for appointment in schedule_list %}
        {
            "c": "{{ appointment.c }}",
                "date": " {{ appointment.appdate }}",
                    "time": " {{ appointment.apptime }}"
        }
        {% if not forloop.last %}, {% endif %}
        {% endfor %}
          ];


        const appointmentContainer = document.getElementById('appointmentContainer');


        appointments.forEach(appoint => {

            const scheduleElement = document.createElement('div');

            //for date
            const dateTitle = document.createElement('div');
            dateTitle.innerHTML = `<b> Date: ${appoint.date}</b>`;
            scheduleElement.appendChild(dateTitle);


            //for time
            const timeTitle = document.createElement('div');
            timeTitle.innerHTML = `<b> Time: ${appoint.time}</b>`;
            scheduleElement.appendChild(timeTitle);

            const scheduleButton = document.createElement('button');
            scheduleButton.innerHTML = `Schedule`;
            scheduleButton.setAttribute('name', 'submitButton');

            const line = document.createElement('hr');

            appointmentContainer.appendChild(scheduleElement).appendChild(scheduleButton);

            appointmentContainer.appendChild(line);

            // Event listener for schedule button
            scheduleButton.addEventListener('click', function () {
               //  console.log("Company ID:", appoint.c_id);
               // scheduleAppointment(appoint.c_id, appoint.date, appoint.time, event.target);

                console.log("Company ID:", appoint.c); // Access the company ID using appoint.c
         scheduleAppointment(appoint.c, appoint.date, appoint.time, event.target);
            });

        });

    function scheduleAppointment(c, date, time, button) {
    // Parse date string into a Moment.js object


    const parsedDate = moment(date);

    // Format date in YYYY-MM-DD format
    const formattedDate = parsedDate.format('YYYY-MM-DD');

    // Parse time string using Moment.js
    const parsedTime = moment(time, ['h:mm A', 'H:mm:ss']); // Specify possible time formats

    if (!parsedTime.isValid()) {
        console.error('Error parsing time:', time);
        return;
    }

    // Format time in HH:MM:SS format
    const formattedTime = parsedTime.format('HH:mm:ss');






    // Send data to the server
    fetch(`/poolcleanapp/client_Schedule/${c}/schedule_appointment/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            c: c,
            appdate: formattedDate,
            apptime: formattedTime
        })
    })
        .then(response => {
            if (response.ok) {
                console.log('Appointment scheduled successfully!');
                alert('Appointment scheduled successfully!');
                window.location.href = "{% url 'stripeTest' %}";
            } else {
                response.json().then(data => {
                    if (data.error === 'Appointment already scheduled.') {
                        alert('Scheduling failed, appointment already scheduled. Schedule another timing');
                        button.classList.add('alreadyScheduled');
                        button.disabled = true; // Disabling the button
                    } else {
                        console.error('Failed to schedule appointment:', data.error);
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error scheduling appointment:', error);
        });
}
 //console.log('Schedule List:', {{ schedule_list|safe }});

    </script>


</body>

</html>